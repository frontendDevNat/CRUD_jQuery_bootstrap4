$(function () {
	let needRow;
	let needId;
	let tblProducts = JSON.parse(localStorage.getItem("tblProducts"));
	$.getJSON('data.json', function (data) {//get json file via ajax method of jquery
		for (let i of data) {
			createRows(i);
		}
		tblProducts = data;
		localStorage.setItem("tblProducts", JSON.stringify(tblProducts));//save changes in the local store
	});


	$('#table tbody').delegate('.edit', 'click', function () {//click on the dynamically added buttons
		$('#form input[data-target="check"]').removeClass('is-invalid');
		needRow = $(this).closest('tr');
		needId = needRow.attr('id');
		inpForm(needId, tblProducts);
		$('#form input[data-target="check"]').on('focusout', function () {
			validate($(this))
		});
		$('#btnAdd').removeClass('add').addClass('edit');
		$('#btnAdd').attr('value', 'Update').removeAttr('data-dismiss');
	});


	$('#table tbody').delegate('.delete', 'click', function () {
		let row = $(this);
		let id = row.closest('tr').attr('id');
		$('#confirm ').on('click', function () {
			rowDelete(row, id, tblProducts);
			localStorage.setItem("tblProducts", JSON.stringify(tblProducts));//save changes in the local store
		});
	});

	$('#addNew').on('click', function () {
		$('#form input[data-target="check"]').removeClass('is-invalid');
		$('#form')[0].reset();
		$('#form input[data-target="check"]').on('focusout', function () {
			validate($(this))
		});
		$('#btnAdd').removeClass('edit').addClass('add').removeAttr('data-dismiss');
		$('#btnAdd').attr('value', 'Add');
	});

	$('#btnAdd').on('click', function () {
		if (this.classList.contains('add')) {//case of add new row
			if (!validate($('input[data-target="check"]'))) {
				addRow(tblProducts);//method for add
				localStorage.setItem("tblProducts", JSON.stringify(tblProducts));//save changes in the local store
				$(this).attr('data-dismiss', 'modal'); //close the modal window
			}

		} else if (this.classList.contains('edit')) {//case of edit row
			if (!validate($('input[data-target="check"]'))) {
				needRow.remove();//remove element from DOM
				editRow(needId, tblProducts);//method for edit
				localStorage.setItem("tblProducts", JSON.stringify(tblProducts));
				$(this).attr('data-dismiss', 'modal');//close the modal window
			}
		}
		;
	});

	//filter of products
	$('#searchName').on('submit', function (e) {
		e.preventDefault();
		let filterName = $('#searchName input[type="search"]').val().toLowerCase();
		$("#table").find("tr").each(function (index) {
			if (!index) return;
			let id = $(this).find('td').first().text();
			$(this).toggle(id.indexOf(filterName) !== -1);
			console.log(id.indexOf(filterName));
		});
	});

	//sort by product name
	$('#sortName').on('click', function () {
		let spanName = $(this);
		spanName.toggleClass('upName');
		let orderName;
		if (spanName.is('.upName')) {
			spanName.html('▽').attr('title', 'sort down');
			orderName = tblProducts.sort((a, b) => a.name > b.name ? -1 : 1);
		} else {
			orderName = tblProducts.sort((a, b) => a.name > b.name ? 1 : -1);
			spanName.html('△').attr('title', 'sort up');
		}
		$('tbody tr').remove();
		$.each(orderName, function (key) {
			createRows(orderName[key]);
		})
	});

	//sort by product price
	$('#sortPrice').on('click', function () {
		let spanPrice = $(this);
		spanPrice.toggleClass('upPrice');
		let orderPrice;
		if (spanPrice.is('.upPrice')) {
			spanPrice.html('▽').attr('title', 'sort down');
			orderPrice = tblProducts.sort((a, b) => a.price > b.price ? -1 : 1);
		} else {
			orderPrice = tblProducts.sort((a, b) => a.price > b.price ? 1 : -1);
			spanPrice.html('△').attr('title', 'sort up');
		}
		$('tbody tr').remove();
		$.each(orderPrice, function (key) {
			createRows(orderPrice[key]);
		})
	});

});


//Methods
    //create new row like DOM element
	function createRows(data) {
		let formMPrice = accounting.formatMoney(data.price);
		//writing code by ES 5 and earlier versions
		/* $('#table tbody').append('<tr id="' + data.id + '">' + '<td class="nameProduct">' + data.name + '</td><td><div class="badge badge-pill badge-secondary justify-content-center">' + data.count + '</div>' +
		'</td><td class="text-center">' + formMPrice + '</td><td class="d-flex justify-content-center"><button type="button" class="btn btn-success edit mr-4" data-toggle="modal" data-target="#createItem">Edit</button><button type="button" class="btn btn-success delete" data-toggle="modal" data-target="#deleteItem"> Delete</button></td><tr>');
		*/
		//writing code by ES 6
		$('#table tbody').append(`<tr id=${data.id}><td class="nameProduct">${data.name}</td>
		<td><div class="badge badge-pill badge-secondary justify-content-center">${data.count}</div></td>
		<td class="text-center">${formMPrice} </td>
		<td class="d-flex justify-content-center">
		<button type="button" class="btn btn-success edit mr-4" data-toggle="modal" data-target="#createItem">Edit</button>
		<button type="button" class="btn btn-success delete" data-toggle="modal" data-target="#deleteItem"> Delete</button></td><tr>`);
	}

	//delete row from table
    function rowDelete(el, id, arr) {
        el.closest('tr').remove();//delete from table
        $.each(arr, function (key) {//delete from data array
            if (this.id == id) {
                arr.splice(key, 1);
            }
        });
    }

	//find out maximum of the id in order to get id for new row
	function maxId(arr) {
		let arrId = [];
		$.each(arr, function (key) {
			arrId.push(arr[key].id)
		});
		let maxId = Math.max.apply(null, arrId);
		return ++maxId;
	}

	//add new row
	function addRow(arr) {
		let newId = maxId(arr);
		let newRow = {
			id: newId,
			name: $('input[data-validation ="name"]').val(),
			count: $('input[data-validation ="count"]').val(),
			price: $('input[data-validation ="price"]').val()
		};
		arr.push(newRow);
		let filterName = $('#searchName input[type="search"]').val().toLowerCase();
		$("#table").find("tr").each(function(index) {
			if (!index) return;
			var id = $(this).find("td").first().text();
			$(this).toggle(id.indexOf(filterName) !== -1);
		});
		createRows(newRow);
	}

	//fill in form of the modal window for add/edit row
	function inpForm(id, arr) {
		$.each(arr, function(key){
            if(this.id == id){
	            $('input[data-validation ="name"]').val(arr[key].name);
	            $('input[data-validation ="count"]').val(arr[key].count);
	            String($('input[data-validation ="price"]').val(arr[key].price));
            }
        })
	}

	//edit row
	function editRow(id, arr) {
		$.each(arr, function (key) {
			if(this.id == id) {
				arr[key] = {
					id: arr[key].id,
					name: $('input[data-validation ="name"]').val(),
					count: Number($('input[data-validation ="count"]').val()),
					price: Number($('input[data-validation ="price"]').val())
				};
				createRows(arr[key]);
			}
		});
	}

	//validation of form add/edit row
	function validate(arr) {
    let patterns = {
        name: /^([A-Za-z\d][\s]{0,2}){1,15}$/i,
        count: /^[0-9]+$/,
        price: /^\d+(\.\d{0,2})*$/
    };
	let err = false;
	let msg = "";
	$.each(arr, function (key) {
				let value = $(this).val();
		let patternName = $(this).attr('data-validation');
		console.log(patternName);
		let pattern = patterns[patternName];
		if (!pattern.test(value)) {
			console.log(pattern.test(value));

			$(this).addClass('is-invalid');
			err = true;

			if(value == ""){
				msg = "The field can not be empty";
			}else if(patternName == "name" && value.length > 15) {
				msg = "Amount of symbols can not be more 15";
			}else if(patternName == "count" || patternName == "price"){
				msg = "The field can consist only numbers";
			}else{
				msg = "The field can not consist only spaces"
			}
			$(this).next('div').html(msg);
		}
		else {
			$(this).next('div').html("");
			$(this).removeClass('is-invalid');
		}
	});
		return err;
	}
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiIiwic291cmNlcyI6WyJtYWluLmpzIl0sInNvdXJjZXNDb250ZW50IjpbIiQoZnVuY3Rpb24gKCkge1xuXHRsZXQgbmVlZFJvdztcblx0bGV0IG5lZWRJZDtcblx0bGV0IHRibFByb2R1Y3RzID0gSlNPTi5wYXJzZShsb2NhbFN0b3JhZ2UuZ2V0SXRlbShcInRibFByb2R1Y3RzXCIpKTtcblx0JC5nZXRKU09OKCdkYXRhLmpzb24nLCBmdW5jdGlvbiAoZGF0YSkgey8vZ2V0IGpzb24gZmlsZSB2aWEgYWpheCBtZXRob2Qgb2YganF1ZXJ5XG5cdFx0Zm9yIChsZXQgaSBvZiBkYXRhKSB7XG5cdFx0XHRjcmVhdGVSb3dzKGkpO1xuXHRcdH1cblx0XHR0YmxQcm9kdWN0cyA9IGRhdGE7XG5cdFx0bG9jYWxTdG9yYWdlLnNldEl0ZW0oXCJ0YmxQcm9kdWN0c1wiLCBKU09OLnN0cmluZ2lmeSh0YmxQcm9kdWN0cykpOy8vc2F2ZSBjaGFuZ2VzIGluIHRoZSBsb2NhbCBzdG9yZVxuXHR9KTtcblxuXG5cdCQoJyN0YWJsZSB0Ym9keScpLmRlbGVnYXRlKCcuZWRpdCcsICdjbGljaycsIGZ1bmN0aW9uICgpIHsvL2NsaWNrIG9uIHRoZSBkeW5hbWljYWxseSBhZGRlZCBidXR0b25zXG5cdFx0JCgnI2Zvcm0gaW5wdXRbZGF0YS10YXJnZXQ9XCJjaGVja1wiXScpLnJlbW92ZUNsYXNzKCdpcy1pbnZhbGlkJyk7XG5cdFx0bmVlZFJvdyA9ICQodGhpcykuY2xvc2VzdCgndHInKTtcblx0XHRuZWVkSWQgPSBuZWVkUm93LmF0dHIoJ2lkJyk7XG5cdFx0aW5wRm9ybShuZWVkSWQsIHRibFByb2R1Y3RzKTtcblx0XHQkKCcjZm9ybSBpbnB1dFtkYXRhLXRhcmdldD1cImNoZWNrXCJdJykub24oJ2ZvY3Vzb3V0JywgZnVuY3Rpb24gKCkge1xuXHRcdFx0dmFsaWRhdGUoJCh0aGlzKSlcblx0XHR9KTtcblx0XHQkKCcjYnRuQWRkJykucmVtb3ZlQ2xhc3MoJ2FkZCcpLmFkZENsYXNzKCdlZGl0Jyk7XG5cdFx0JCgnI2J0bkFkZCcpLmF0dHIoJ3ZhbHVlJywgJ1VwZGF0ZScpLnJlbW92ZUF0dHIoJ2RhdGEtZGlzbWlzcycpO1xuXHR9KTtcblxuXG5cdCQoJyN0YWJsZSB0Ym9keScpLmRlbGVnYXRlKCcuZGVsZXRlJywgJ2NsaWNrJywgZnVuY3Rpb24gKCkge1xuXHRcdGxldCByb3cgPSAkKHRoaXMpO1xuXHRcdGxldCBpZCA9IHJvdy5jbG9zZXN0KCd0cicpLmF0dHIoJ2lkJyk7XG5cdFx0JCgnI2NvbmZpcm0gJykub24oJ2NsaWNrJywgZnVuY3Rpb24gKCkge1xuXHRcdFx0cm93RGVsZXRlKHJvdywgaWQsIHRibFByb2R1Y3RzKTtcblx0XHRcdGxvY2FsU3RvcmFnZS5zZXRJdGVtKFwidGJsUHJvZHVjdHNcIiwgSlNPTi5zdHJpbmdpZnkodGJsUHJvZHVjdHMpKTsvL3NhdmUgY2hhbmdlcyBpbiB0aGUgbG9jYWwgc3RvcmVcblx0XHR9KTtcblx0fSk7XG5cblx0JCgnI2FkZE5ldycpLm9uKCdjbGljaycsIGZ1bmN0aW9uICgpIHtcblx0XHQkKCcjZm9ybSBpbnB1dFtkYXRhLXRhcmdldD1cImNoZWNrXCJdJykucmVtb3ZlQ2xhc3MoJ2lzLWludmFsaWQnKTtcblx0XHQkKCcjZm9ybScpWzBdLnJlc2V0KCk7XG5cdFx0JCgnI2Zvcm0gaW5wdXRbZGF0YS10YXJnZXQ9XCJjaGVja1wiXScpLm9uKCdmb2N1c291dCcsIGZ1bmN0aW9uICgpIHtcblx0XHRcdHZhbGlkYXRlKCQodGhpcykpXG5cdFx0fSk7XG5cdFx0JCgnI2J0bkFkZCcpLnJlbW92ZUNsYXNzKCdlZGl0JykuYWRkQ2xhc3MoJ2FkZCcpLnJlbW92ZUF0dHIoJ2RhdGEtZGlzbWlzcycpO1xuXHRcdCQoJyNidG5BZGQnKS5hdHRyKCd2YWx1ZScsICdBZGQnKTtcblx0fSk7XG5cblx0JCgnI2J0bkFkZCcpLm9uKCdjbGljaycsIGZ1bmN0aW9uICgpIHtcblx0XHRpZiAodGhpcy5jbGFzc0xpc3QuY29udGFpbnMoJ2FkZCcpKSB7Ly9jYXNlIG9mIGFkZCBuZXcgcm93XG5cdFx0XHRpZiAoIXZhbGlkYXRlKCQoJ2lucHV0W2RhdGEtdGFyZ2V0PVwiY2hlY2tcIl0nKSkpIHtcblx0XHRcdFx0YWRkUm93KHRibFByb2R1Y3RzKTsvL21ldGhvZCBmb3IgYWRkXG5cdFx0XHRcdGxvY2FsU3RvcmFnZS5zZXRJdGVtKFwidGJsUHJvZHVjdHNcIiwgSlNPTi5zdHJpbmdpZnkodGJsUHJvZHVjdHMpKTsvL3NhdmUgY2hhbmdlcyBpbiB0aGUgbG9jYWwgc3RvcmVcblx0XHRcdFx0JCh0aGlzKS5hdHRyKCdkYXRhLWRpc21pc3MnLCAnbW9kYWwnKTsgLy9jbG9zZSB0aGUgbW9kYWwgd2luZG93XG5cdFx0XHR9XG5cblx0XHR9IGVsc2UgaWYgKHRoaXMuY2xhc3NMaXN0LmNvbnRhaW5zKCdlZGl0JykpIHsvL2Nhc2Ugb2YgZWRpdCByb3dcblx0XHRcdGlmICghdmFsaWRhdGUoJCgnaW5wdXRbZGF0YS10YXJnZXQ9XCJjaGVja1wiXScpKSkge1xuXHRcdFx0XHRuZWVkUm93LnJlbW92ZSgpOy8vcmVtb3ZlIGVsZW1lbnQgZnJvbSBET01cblx0XHRcdFx0ZWRpdFJvdyhuZWVkSWQsIHRibFByb2R1Y3RzKTsvL21ldGhvZCBmb3IgZWRpdFxuXHRcdFx0XHRsb2NhbFN0b3JhZ2Uuc2V0SXRlbShcInRibFByb2R1Y3RzXCIsIEpTT04uc3RyaW5naWZ5KHRibFByb2R1Y3RzKSk7XG5cdFx0XHRcdCQodGhpcykuYXR0cignZGF0YS1kaXNtaXNzJywgJ21vZGFsJyk7Ly9jbG9zZSB0aGUgbW9kYWwgd2luZG93XG5cdFx0XHR9XG5cdFx0fVxuXHRcdDtcblx0fSk7XG5cblx0Ly9maWx0ZXIgb2YgcHJvZHVjdHNcblx0JCgnI3NlYXJjaE5hbWUnKS5vbignc3VibWl0JywgZnVuY3Rpb24gKGUpIHtcblx0XHRlLnByZXZlbnREZWZhdWx0KCk7XG5cdFx0bGV0IGZpbHRlck5hbWUgPSAkKCcjc2VhcmNoTmFtZSBpbnB1dFt0eXBlPVwic2VhcmNoXCJdJykudmFsKCkudG9Mb3dlckNhc2UoKTtcblx0XHQkKFwiI3RhYmxlXCIpLmZpbmQoXCJ0clwiKS5lYWNoKGZ1bmN0aW9uIChpbmRleCkge1xuXHRcdFx0aWYgKCFpbmRleCkgcmV0dXJuO1xuXHRcdFx0bGV0IGlkID0gJCh0aGlzKS5maW5kKCd0ZCcpLmZpcnN0KCkudGV4dCgpO1xuXHRcdFx0JCh0aGlzKS50b2dnbGUoaWQuaW5kZXhPZihmaWx0ZXJOYW1lKSAhPT0gLTEpO1xuXHRcdFx0Y29uc29sZS5sb2coaWQuaW5kZXhPZihmaWx0ZXJOYW1lKSk7XG5cdFx0fSk7XG5cdH0pO1xuXG5cdC8vc29ydCBieSBwcm9kdWN0IG5hbWVcblx0JCgnI3NvcnROYW1lJykub24oJ2NsaWNrJywgZnVuY3Rpb24gKCkge1xuXHRcdGxldCBzcGFuTmFtZSA9ICQodGhpcyk7XG5cdFx0c3Bhbk5hbWUudG9nZ2xlQ2xhc3MoJ3VwTmFtZScpO1xuXHRcdGxldCBvcmRlck5hbWU7XG5cdFx0aWYgKHNwYW5OYW1lLmlzKCcudXBOYW1lJykpIHtcblx0XHRcdHNwYW5OYW1lLmh0bWwoJ+KWvScpLmF0dHIoJ3RpdGxlJywgJ3NvcnQgZG93bicpO1xuXHRcdFx0b3JkZXJOYW1lID0gdGJsUHJvZHVjdHMuc29ydCgoYSwgYikgPT4gYS5uYW1lID4gYi5uYW1lID8gLTEgOiAxKTtcblx0XHR9IGVsc2Uge1xuXHRcdFx0b3JkZXJOYW1lID0gdGJsUHJvZHVjdHMuc29ydCgoYSwgYikgPT4gYS5uYW1lID4gYi5uYW1lID8gMSA6IC0xKTtcblx0XHRcdHNwYW5OYW1lLmh0bWwoJ+KWsycpLmF0dHIoJ3RpdGxlJywgJ3NvcnQgdXAnKTtcblx0XHR9XG5cdFx0JCgndGJvZHkgdHInKS5yZW1vdmUoKTtcblx0XHQkLmVhY2gob3JkZXJOYW1lLCBmdW5jdGlvbiAoa2V5KSB7XG5cdFx0XHRjcmVhdGVSb3dzKG9yZGVyTmFtZVtrZXldKTtcblx0XHR9KVxuXHR9KTtcblxuXHQvL3NvcnQgYnkgcHJvZHVjdCBwcmljZVxuXHQkKCcjc29ydFByaWNlJykub24oJ2NsaWNrJywgZnVuY3Rpb24gKCkge1xuXHRcdGxldCBzcGFuUHJpY2UgPSAkKHRoaXMpO1xuXHRcdHNwYW5QcmljZS50b2dnbGVDbGFzcygndXBQcmljZScpO1xuXHRcdGxldCBvcmRlclByaWNlO1xuXHRcdGlmIChzcGFuUHJpY2UuaXMoJy51cFByaWNlJykpIHtcblx0XHRcdHNwYW5QcmljZS5odG1sKCfilr0nKS5hdHRyKCd0aXRsZScsICdzb3J0IGRvd24nKTtcblx0XHRcdG9yZGVyUHJpY2UgPSB0YmxQcm9kdWN0cy5zb3J0KChhLCBiKSA9PiBhLnByaWNlID4gYi5wcmljZSA/IC0xIDogMSk7XG5cdFx0fSBlbHNlIHtcblx0XHRcdG9yZGVyUHJpY2UgPSB0YmxQcm9kdWN0cy5zb3J0KChhLCBiKSA9PiBhLnByaWNlID4gYi5wcmljZSA/IDEgOiAtMSk7XG5cdFx0XHRzcGFuUHJpY2UuaHRtbCgn4pazJykuYXR0cigndGl0bGUnLCAnc29ydCB1cCcpO1xuXHRcdH1cblx0XHQkKCd0Ym9keSB0cicpLnJlbW92ZSgpO1xuXHRcdCQuZWFjaChvcmRlclByaWNlLCBmdW5jdGlvbiAoa2V5KSB7XG5cdFx0XHRjcmVhdGVSb3dzKG9yZGVyUHJpY2Vba2V5XSk7XG5cdFx0fSlcblx0fSk7XG5cbn0pO1xuXG5cbi8vTWV0aG9kc1xuICAgIC8vY3JlYXRlIG5ldyByb3cgbGlrZSBET00gZWxlbWVudFxuXHRmdW5jdGlvbiBjcmVhdGVSb3dzKGRhdGEpIHtcblx0XHRsZXQgZm9ybU1QcmljZSA9IGFjY291bnRpbmcuZm9ybWF0TW9uZXkoZGF0YS5wcmljZSk7XG5cdFx0Ly93cml0aW5nIGNvZGUgYnkgRVMgNSBhbmQgZWFybGllciB2ZXJzaW9uc1xuXHRcdC8qICQoJyN0YWJsZSB0Ym9keScpLmFwcGVuZCgnPHRyIGlkPVwiJyArIGRhdGEuaWQgKyAnXCI+JyArICc8dGQgY2xhc3M9XCJuYW1lUHJvZHVjdFwiPicgKyBkYXRhLm5hbWUgKyAnPC90ZD48dGQ+PGRpdiBjbGFzcz1cImJhZGdlIGJhZGdlLXBpbGwgYmFkZ2Utc2Vjb25kYXJ5IGp1c3RpZnktY29udGVudC1jZW50ZXJcIj4nICsgZGF0YS5jb3VudCArICc8L2Rpdj4nICtcblx0XHQnPC90ZD48dGQgY2xhc3M9XCJ0ZXh0LWNlbnRlclwiPicgKyBmb3JtTVByaWNlICsgJzwvdGQ+PHRkIGNsYXNzPVwiZC1mbGV4IGp1c3RpZnktY29udGVudC1jZW50ZXJcIj48YnV0dG9uIHR5cGU9XCJidXR0b25cIiBjbGFzcz1cImJ0biBidG4tc3VjY2VzcyBlZGl0IG1yLTRcIiBkYXRhLXRvZ2dsZT1cIm1vZGFsXCIgZGF0YS10YXJnZXQ9XCIjY3JlYXRlSXRlbVwiPkVkaXQ8L2J1dHRvbj48YnV0dG9uIHR5cGU9XCJidXR0b25cIiBjbGFzcz1cImJ0biBidG4tc3VjY2VzcyBkZWxldGVcIiBkYXRhLXRvZ2dsZT1cIm1vZGFsXCIgZGF0YS10YXJnZXQ9XCIjZGVsZXRlSXRlbVwiPiBEZWxldGU8L2J1dHRvbj48L3RkPjx0cj4nKTtcblx0XHQqL1xuXHRcdC8vd3JpdGluZyBjb2RlIGJ5IEVTIDZcblx0XHQkKCcjdGFibGUgdGJvZHknKS5hcHBlbmQoYDx0ciBpZD0ke2RhdGEuaWR9Pjx0ZCBjbGFzcz1cIm5hbWVQcm9kdWN0XCI+JHtkYXRhLm5hbWV9PC90ZD5cblx0XHQ8dGQ+PGRpdiBjbGFzcz1cImJhZGdlIGJhZGdlLXBpbGwgYmFkZ2Utc2Vjb25kYXJ5IGp1c3RpZnktY29udGVudC1jZW50ZXJcIj4ke2RhdGEuY291bnR9PC9kaXY+PC90ZD5cblx0XHQ8dGQgY2xhc3M9XCJ0ZXh0LWNlbnRlclwiPiR7Zm9ybU1QcmljZX0gPC90ZD5cblx0XHQ8dGQgY2xhc3M9XCJkLWZsZXgganVzdGlmeS1jb250ZW50LWNlbnRlclwiPlxuXHRcdDxidXR0b24gdHlwZT1cImJ1dHRvblwiIGNsYXNzPVwiYnRuIGJ0bi1zdWNjZXNzIGVkaXQgbXItNFwiIGRhdGEtdG9nZ2xlPVwibW9kYWxcIiBkYXRhLXRhcmdldD1cIiNjcmVhdGVJdGVtXCI+RWRpdDwvYnV0dG9uPlxuXHRcdDxidXR0b24gdHlwZT1cImJ1dHRvblwiIGNsYXNzPVwiYnRuIGJ0bi1zdWNjZXNzIGRlbGV0ZVwiIGRhdGEtdG9nZ2xlPVwibW9kYWxcIiBkYXRhLXRhcmdldD1cIiNkZWxldGVJdGVtXCI+IERlbGV0ZTwvYnV0dG9uPjwvdGQ+PHRyPmApO1xuXHR9XG5cblx0Ly9kZWxldGUgcm93IGZyb20gdGFibGVcbiAgICBmdW5jdGlvbiByb3dEZWxldGUoZWwsIGlkLCBhcnIpIHtcbiAgICAgICAgZWwuY2xvc2VzdCgndHInKS5yZW1vdmUoKTsvL2RlbGV0ZSBmcm9tIHRhYmxlXG4gICAgICAgICQuZWFjaChhcnIsIGZ1bmN0aW9uIChrZXkpIHsvL2RlbGV0ZSBmcm9tIGRhdGEgYXJyYXlcbiAgICAgICAgICAgIGlmICh0aGlzLmlkID09IGlkKSB7XG4gICAgICAgICAgICAgICAgYXJyLnNwbGljZShrZXksIDEpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9XG5cblx0Ly9maW5kIG91dCBtYXhpbXVtIG9mIHRoZSBpZCBpbiBvcmRlciB0byBnZXQgaWQgZm9yIG5ldyByb3dcblx0ZnVuY3Rpb24gbWF4SWQoYXJyKSB7XG5cdFx0bGV0IGFycklkID0gW107XG5cdFx0JC5lYWNoKGFyciwgZnVuY3Rpb24gKGtleSkge1xuXHRcdFx0YXJySWQucHVzaChhcnJba2V5XS5pZClcblx0XHR9KTtcblx0XHRsZXQgbWF4SWQgPSBNYXRoLm1heC5hcHBseShudWxsLCBhcnJJZCk7XG5cdFx0cmV0dXJuICsrbWF4SWQ7XG5cdH1cblxuXHQvL2FkZCBuZXcgcm93XG5cdGZ1bmN0aW9uIGFkZFJvdyhhcnIpIHtcblx0XHRsZXQgbmV3SWQgPSBtYXhJZChhcnIpO1xuXHRcdGxldCBuZXdSb3cgPSB7XG5cdFx0XHRpZDogbmV3SWQsXG5cdFx0XHRuYW1lOiAkKCdpbnB1dFtkYXRhLXZhbGlkYXRpb24gPVwibmFtZVwiXScpLnZhbCgpLFxuXHRcdFx0Y291bnQ6ICQoJ2lucHV0W2RhdGEtdmFsaWRhdGlvbiA9XCJjb3VudFwiXScpLnZhbCgpLFxuXHRcdFx0cHJpY2U6ICQoJ2lucHV0W2RhdGEtdmFsaWRhdGlvbiA9XCJwcmljZVwiXScpLnZhbCgpXG5cdFx0fTtcblx0XHRhcnIucHVzaChuZXdSb3cpO1xuXHRcdGxldCBmaWx0ZXJOYW1lID0gJCgnI3NlYXJjaE5hbWUgaW5wdXRbdHlwZT1cInNlYXJjaFwiXScpLnZhbCgpLnRvTG93ZXJDYXNlKCk7XG5cdFx0JChcIiN0YWJsZVwiKS5maW5kKFwidHJcIikuZWFjaChmdW5jdGlvbihpbmRleCkge1xuXHRcdFx0aWYgKCFpbmRleCkgcmV0dXJuO1xuXHRcdFx0dmFyIGlkID0gJCh0aGlzKS5maW5kKFwidGRcIikuZmlyc3QoKS50ZXh0KCk7XG5cdFx0XHQkKHRoaXMpLnRvZ2dsZShpZC5pbmRleE9mKGZpbHRlck5hbWUpICE9PSAtMSk7XG5cdFx0fSk7XG5cdFx0Y3JlYXRlUm93cyhuZXdSb3cpO1xuXHR9XG5cblx0Ly9maWxsIGluIGZvcm0gb2YgdGhlIG1vZGFsIHdpbmRvdyBmb3IgYWRkL2VkaXQgcm93XG5cdGZ1bmN0aW9uIGlucEZvcm0oaWQsIGFycikge1xuXHRcdCQuZWFjaChhcnIsIGZ1bmN0aW9uKGtleSl7XG4gICAgICAgICAgICBpZih0aGlzLmlkID09IGlkKXtcblx0ICAgICAgICAgICAgJCgnaW5wdXRbZGF0YS12YWxpZGF0aW9uID1cIm5hbWVcIl0nKS52YWwoYXJyW2tleV0ubmFtZSk7XG5cdCAgICAgICAgICAgICQoJ2lucHV0W2RhdGEtdmFsaWRhdGlvbiA9XCJjb3VudFwiXScpLnZhbChhcnJba2V5XS5jb3VudCk7XG5cdCAgICAgICAgICAgIFN0cmluZygkKCdpbnB1dFtkYXRhLXZhbGlkYXRpb24gPVwicHJpY2VcIl0nKS52YWwoYXJyW2tleV0ucHJpY2UpKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSlcblx0fVxuXG5cdC8vZWRpdCByb3dcblx0ZnVuY3Rpb24gZWRpdFJvdyhpZCwgYXJyKSB7XG5cdFx0JC5lYWNoKGFyciwgZnVuY3Rpb24gKGtleSkge1xuXHRcdFx0aWYodGhpcy5pZCA9PSBpZCkge1xuXHRcdFx0XHRhcnJba2V5XSA9IHtcblx0XHRcdFx0XHRpZDogYXJyW2tleV0uaWQsXG5cdFx0XHRcdFx0bmFtZTogJCgnaW5wdXRbZGF0YS12YWxpZGF0aW9uID1cIm5hbWVcIl0nKS52YWwoKSxcblx0XHRcdFx0XHRjb3VudDogTnVtYmVyKCQoJ2lucHV0W2RhdGEtdmFsaWRhdGlvbiA9XCJjb3VudFwiXScpLnZhbCgpKSxcblx0XHRcdFx0XHRwcmljZTogTnVtYmVyKCQoJ2lucHV0W2RhdGEtdmFsaWRhdGlvbiA9XCJwcmljZVwiXScpLnZhbCgpKVxuXHRcdFx0XHR9O1xuXHRcdFx0XHRjcmVhdGVSb3dzKGFycltrZXldKTtcblx0XHRcdH1cblx0XHR9KTtcblx0fVxuXG5cdC8vdmFsaWRhdGlvbiBvZiBmb3JtIGFkZC9lZGl0IHJvd1xuXHRmdW5jdGlvbiB2YWxpZGF0ZShhcnIpIHtcbiAgICBsZXQgcGF0dGVybnMgPSB7XG4gICAgICAgIG5hbWU6IC9eKFtBLVphLXpcXGRdW1xcc117MCwyfSl7MSwxNX0kL2ksXG4gICAgICAgIGNvdW50OiAvXlswLTldKyQvLFxuICAgICAgICBwcmljZTogL15cXGQrKFxcLlxcZHswLDJ9KSokL1xuICAgIH07XG5cdGxldCBlcnIgPSBmYWxzZTtcblx0bGV0IG1zZyA9IFwiXCI7XG5cdCQuZWFjaChhcnIsIGZ1bmN0aW9uIChrZXkpIHtcblx0XHRcdFx0bGV0IHZhbHVlID0gJCh0aGlzKS52YWwoKTtcblx0XHRsZXQgcGF0dGVybk5hbWUgPSAkKHRoaXMpLmF0dHIoJ2RhdGEtdmFsaWRhdGlvbicpO1xuXHRcdGNvbnNvbGUubG9nKHBhdHRlcm5OYW1lKTtcblx0XHRsZXQgcGF0dGVybiA9IHBhdHRlcm5zW3BhdHRlcm5OYW1lXTtcblx0XHRpZiAoIXBhdHRlcm4udGVzdCh2YWx1ZSkpIHtcblx0XHRcdGNvbnNvbGUubG9nKHBhdHRlcm4udGVzdCh2YWx1ZSkpO1xuXG5cdFx0XHQkKHRoaXMpLmFkZENsYXNzKCdpcy1pbnZhbGlkJyk7XG5cdFx0XHRlcnIgPSB0cnVlO1xuXG5cdFx0XHRpZih2YWx1ZSA9PSBcIlwiKXtcblx0XHRcdFx0bXNnID0gXCJUaGUgZmllbGQgY2FuIG5vdCBiZSBlbXB0eVwiO1xuXHRcdFx0fWVsc2UgaWYocGF0dGVybk5hbWUgPT0gXCJuYW1lXCIgJiYgdmFsdWUubGVuZ3RoID4gMTUpIHtcblx0XHRcdFx0bXNnID0gXCJBbW91bnQgb2Ygc3ltYm9scyBjYW4gbm90IGJlIG1vcmUgMTVcIjtcblx0XHRcdH1lbHNlIGlmKHBhdHRlcm5OYW1lID09IFwiY291bnRcIiB8fCBwYXR0ZXJuTmFtZSA9PSBcInByaWNlXCIpe1xuXHRcdFx0XHRtc2cgPSBcIlRoZSBmaWVsZCBjYW4gY29uc2lzdCBvbmx5IG51bWJlcnNcIjtcblx0XHRcdH1lbHNle1xuXHRcdFx0XHRtc2cgPSBcIlRoZSBmaWVsZCBjYW4gbm90IGNvbnNpc3Qgb25seSBzcGFjZXNcIlxuXHRcdFx0fVxuXHRcdFx0JCh0aGlzKS5uZXh0KCdkaXYnKS5odG1sKG1zZyk7XG5cdFx0fVxuXHRcdGVsc2Uge1xuXHRcdFx0JCh0aGlzKS5uZXh0KCdkaXYnKS5odG1sKFwiXCIpO1xuXHRcdFx0JCh0aGlzKS5yZW1vdmVDbGFzcygnaXMtaW52YWxpZCcpO1xuXHRcdH1cblx0fSk7XG5cdFx0cmV0dXJuIGVycjtcblx0fVxuXG5cblxuXG5cblxuXG5cblxuIl0sImZpbGUiOiJtYWluLm1pbi5qcyJ9
